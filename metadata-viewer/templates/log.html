<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ filename }} - Log Viewer</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --accent: #e94560;
            --accent-green: #00d9a0;
            --accent-blue: #4d90fe;
            --accent-yellow: #ffc107;
            --accent-purple: #9c27b0;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-btn {
            background: var(--bg-card);
            color: var(--text-primary);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-btn:hover { background: var(--accent); }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            background: var(--bg-card);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .search-box::placeholder { color: var(--text-secondary); }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
        }
        
        .filter-btn {
            padding: 8px 14px;
            background: var(--bg-card);
            border: none;
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .filter-btn.active { background: var(--accent); }
        .filter-btn:hover { opacity: 0.8; }
        
        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
        }
        
        .log-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .log-entry {
            display: grid;
            grid-template-columns: 90px 60px 1fr;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid var(--bg-card);
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .log-entry:hover { background: rgba(255,255,255,0.05); }
        
        .log-time { color: var(--text-secondary); }
        
        .log-level {
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .log-level.info { color: var(--accent-blue); }
        .log-level.warn, .log-level.warning { color: var(--accent-yellow); }
        .log-level.error { color: var(--accent); }
        .log-level.debug { color: var(--text-secondary); }
        
        .log-message { word-break: break-word; }
        
        .log-details {
            margin-top: 5px;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 8px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-count {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .stat-count.blue { color: var(--accent-blue); }
        .stat-count.yellow { color: var(--accent-yellow); }
        .stat-count.red { color: var(--accent); }
        
        .pagination {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .page-btn {
            padding: 8px 14px;
            background: var(--bg-card);
            border: none;
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
        }
        .page-btn:hover { background: var(--accent); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn:disabled:hover { background: var(--bg-card); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üìã</span>
                {{ filename }}
            </h1>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                    <div>Created: {{ created }}</div>
                    <div>Modified: {{ modified }}</div>
                </div>
                <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
            </div>
        </div>
        
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <span class="stat-count blue" id="infoCount">-</span>
                <span>Info</span>
            </div>
            <div class="stat-item">
                <span class="stat-count yellow" id="warnCount">-</span>
                <span>Warnings</span>
            </div>
            <div class="stat-item">
                <span class="stat-count red" id="errorCount">-</span>
                <span>Errors</span>
            </div>
        </div>
        
        <div class="controls">
            <input type="text" class="search-box" id="logSearch" placeholder="Search logs..." onkeyup="filterLogs()">
            <div class="filter-buttons">
                <button class="filter-btn active" data-level="all" onclick="setLevelFilter('all', this)">All</button>
                <button class="filter-btn" data-level="INFO" onclick="setLevelFilter('INFO', this)">Info</button>
                <button class="filter-btn" data-level="WARN" onclick="setLevelFilter('WARN', this)">Warn</button>
                <button class="filter-btn" data-level="ERROR" onclick="setLevelFilter('ERROR', this)">Error</button>
            </div>
        </div>
        
        <div class="section">
            <div id="pagination" class="pagination">
                <button onclick="goToPage(1)" class="page-btn" id="firstBtn">¬´ First</button>
                <button onclick="goToPage(currentPage - 1)" class="page-btn" id="prevBtn">‚Äπ Prev</button>
                <span id="pageInfo" style="color: var(--text-secondary);">Page 1 of 1</span>
                <button onclick="goToPage(currentPage + 1)" class="page-btn" id="nextBtn">Next ‚Ä∫</button>
                <button onclick="goToPage(totalPages)" class="page-btn" id="lastBtn">Last ¬ª</button>
                <select id="pageSizeSelect" onchange="changePageSize(this.value)" style="background: var(--bg-card); color: var(--text-primary); border: none; padding: 8px; border-radius: 6px;">
                    <option value="100">100 per page</option>
                    <option value="500">500 per page</option>
                    <option value="1000" selected>1000 per page</option>
                    <option value="5000">5000 per page</option>
                </select>
            </div>
            <div class="log-container" id="logContainer">
                <div class="loading">Loading log entries...</div>
            </div>
        </div>
    </div>
    
    <script>
        let logEntries = [];
        let filteredEntries = [];
        let currentLevelFilter = 'all';
        let currentPage = 1;
        let pageSize = 1000;
        let totalPages = 1;
        
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs/{{ filename }}');
                const data = await response.json();
                logEntries = data.entries.reverse();  // Reverse to show newest first
                
                // Count by level
                let info = 0, warn = 0, error = 0;
                logEntries.forEach(e => {
                    const level = (e.level || '').toUpperCase();
                    if (level === 'INFO') info++;
                    else if (level === 'WARN' || level === 'WARNING') warn++;
                    else if (level === 'ERROR') error++;
                });
                
                document.getElementById('infoCount').textContent = info;
                document.getElementById('warnCount').textContent = warn;
                document.getElementById('errorCount').textContent = error;
                
                renderLogs();
            } catch (error) {
                document.getElementById('logContainer').innerHTML = 
                    `<div class="loading">Error loading logs: ${error.message}</div>`;
            }
        }
        
        function renderLogs() {
            const container = document.getElementById('logContainer');
            const searchTerm = document.getElementById('logSearch').value.toLowerCase();
            
            filteredEntries = logEntries.filter(entry => {
                const text = JSON.stringify(entry).toLowerCase();
                const matchesSearch = text.includes(searchTerm);
                
                const level = (entry.level || '').toUpperCase();
                const matchesLevel = currentLevelFilter === 'all' || 
                    level === currentLevelFilter ||
                    (currentLevelFilter === 'WARN' && level === 'WARNING');
                
                return matchesSearch && matchesLevel;
            });
            
            // Update pagination
            totalPages = Math.max(1, Math.ceil(filteredEntries.length / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            updatePagination();
            
            if (filteredEntries.length === 0) {
                container.innerHTML = '<div class="loading">No matching log entries</div>';
                return;
            }
            
            // Get current page entries
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageEntries = filteredEntries.slice(start, end);
            
            container.innerHTML = pageEntries.map(entry => {
                if (entry.raw) {
                    return `<div class="log-entry">
                        <span class="log-time">-</span>
                        <span class="log-level">RAW</span>
                        <span class="log-message">${escapeHtml(entry.raw)}</span>
                    </div>`;
                }
                
                const time = entry.time ? entry.time.split('T')[1]?.substring(0, 8) || entry.time : '-';
                const level = (entry.level || 'INFO').toUpperCase();
                const message = entry.msg || entry.message || JSON.stringify(entry);
                
                // Build details from extra fields
                let details = [];
                if (entry.file) details.push(`file: ${entry.file}`);
                if (entry.asset) details.push(`asset: ${entry.asset}`);
                if (entry.error) details.push(`error: ${entry.error}`);
                if (entry.album) details.push(`album: ${entry.album}`);
                
                return `<div class="log-entry">
                    <span class="log-time">${time}</span>
                    <span class="log-level ${level.toLowerCase()}">${level}</span>
                    <span class="log-message">
                        ${escapeHtml(message)}
                        ${details.length > 0 ? `<div class="log-details">${escapeHtml(details.join(' | '))}</div>` : ''}
                    </span>
                </div>`;
            }).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function filterLogs() {
            currentPage = 1;  // Reset to first page on search
            renderLogs();
        }
        
        function setLevelFilter(level, btn) {
            currentLevelFilter = level;
            currentPage = 1;  // Reset to first page on filter change
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderLogs();
        }
        
        function updatePagination() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages} (${filteredEntries.length} entries)`;
            document.getElementById('firstBtn').disabled = currentPage <= 1;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            document.getElementById('lastBtn').disabled = currentPage >= totalPages;
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderLogs();
            document.querySelector('.log-container').scrollTop = 0;
        }
        
        function changePageSize(size) {
            pageSize = parseInt(size);
            currentPage = 1;
            renderLogs();
        }
        
        // Load logs on page load
        loadLogs();
    </script>
</body>
</html>
