#!/bin/bash
# Unraid Boot Script (/boot/config/go)
# This script runs after the array is started
# 
# To install: cp this file to /boot/config/go
# Note: Changes here take effect on next reboot

# Start the Management Utility
/usr/local/sbin/emhttp &

# Install SD card auto-import script and udev rule
if [ -f /boot/config/custom-scripts/sd-card-import.sh ]; then
    cp /boot/config/custom-scripts/sd-card-import.sh /usr/local/bin/
    chmod +x /usr/local/bin/sd-card-import.sh
fi
if [ -f /boot/config/custom-scripts/99-sd-card-import.rules ]; then
    cp /boot/config/custom-scripts/99-sd-card-import.rules /etc/udev/rules.d/
    udevadm control --reload-rules
fi

# SD Card Import - immich-go wrapper
if [ -f /boot/config/custom-scripts/immich-go.sh ]; then
    cp /boot/config/custom-scripts/immich-go.sh /usr/local/bin/immich-go
    chmod +x /usr/local/bin/immich-go
fi

# SD Card Import Configuration
# These are used by sd-card-import.sh for direct imports
export IMMICH_SERVER="http://192.168.1.216:2283"
export IMMICH_API_KEY="__IMMICH_API_KEY__"

# Hide failed EDILOCA drive (Serial: AA233930006)
# This drive has failed SMART tests and is in read-only mode
# Comment out or remove this section if you don't have this drive
cat > /etc/udev/rules.d/99-ignore-failed-drive.rules << 'UDEV_EOF'
# Blacklist failed EDILOCA drive (Serial: AA233930006)
# This drive has failed SMART tests and is in read-only mode
# Hide from Unraid, Unassigned Devices plugin, and all device listings

# Match by serial number - hide the main device and all partitions
SUBSYSTEM=="block", ENV{ID_SERIAL_SHORT}=="AA233930006", ENV{UDISKS_IGNORE}="1", ENV{UDISKS_PRESENTATION_HIDE}="1", ENV{UNRAID_HIDDEN}="1", OPTIONS+="ignore_device"

# Match by full serial
SUBSYSTEM=="block", ENV{ID_SERIAL}=="EDILOCA EN855 2TB_AA233930006", ENV{UDISKS_IGNORE}="1", ENV{UDISKS_PRESENTATION_HIDE}="1", ENV{UNRAID_HIDDEN}="1", OPTIONS+="ignore_device"

# Match by kernel device name
KERNEL=="nvme2n1*", ENV{UDISKS_IGNORE}="1", ENV{UDISKS_PRESENTATION_HIDE}="1", ENV{UNRAID_HIDDEN}="1", OPTIONS+="ignore_device"
UDEV_EOF
udevadm control --reload-rules

# Symlinks for persistent home directory storage
# This allows VS Code Server to persist across reboots
ln -sf /mnt/pool/appdata/home/.vscode-server /root/.vscode-server
ln -sf /mnt/pool/appdata /root/appdata

# Fix /etc/profile - remove cd $HOME line that interferes with SSH sessions
# Unraid's default profile changes to home directory, which breaks VS Code Remote
sed -i '/^cd \$HOME$/d' /etc/profile

# Install custom bashrc with docker aliases
if [ -f /boot/config/custom-scripts/bashrc ]; then
    cp /boot/config/custom-scripts/bashrc /root/.bashrc
fi

# Symlink for GitHub Copilot CLI token (persists across reboots)
# The token file lives in the takeout-script state directory
if [ -f /mnt/user/appdata/takeout-script/state/.copilot-token ]; then
    ln -sf /mnt/user/appdata/takeout-script/state/.copilot-token /root/.copilot-token
fi

# Increase /var/log tmpfs to 1GB (default is 128MB which fills up quickly)
mount -o remount,size=1G /var/log

# Clean old rotated logs daily at 3am to prevent /var/log from filling up
echo "0 3 * * * find /var/log -name '*.1' -o -name '*.2' -o -name '*.gz' | xargs rm -f 2>/dev/null" | crontab -
