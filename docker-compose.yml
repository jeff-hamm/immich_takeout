services:
  takeout-backup:
    build:
      context: .
      dockerfile: takeout-backup/Dockerfile
    image: takeout-backup:latest
    container_name: takeout-backup
    restart: "no"
    environment:
      - RCLONE_CONFIG=/config/rclone/rclone.conf
      - RCLONE_REMOTE=${RCLONE_TAKEOUT_PATH:-${RCLONE_REMOTE:-gdrive}:Takeout}
      - GDRIVE_DIR=/data/gdrive/Takeout
      - METADATA_DIR=/data/metadata
    volumes:
      - ${GDRIVE_PATH}/Takeout:/data/gdrive/Takeout
      - ${RCLONE_CONFIG}:/config/rclone/rclone.conf:ro
      - ${IMPORTS_PATH}/metadata:/data/metadata
    network_mode: bridge
    labels:
      - "chadburn.enabled=true"
      - "chadburn.job-exec.takeout-backup.schedule=0 4 * * *"
      - "chadburn.job-exec.takeout-backup.command=python /app/server_backup.py"

  gdrive-backup:
    build:
      context: ./gdrive-backup
    image: gdrive-backup:latest
    container_name: gdrive-backup
    restart: "no"
    environment:
      - RCLONE_CONFIG=/config/rclone/rclone.conf
      - RCLONE_REMOTE=${RCLONE_GDRIVE_PATH:-${RCLONE_REMOTE:-gdrive:}}
    volumes:
      - ${GDRIVE_PATH}:/data/gdrive
      - ${STATE_PATH}/gdrive:/data/state
      - ${RCLONE_CONFIG}:/config/rclone/rclone.conf:ro
    network_mode: bridge
    labels:
      - "chadburn.enabled=true"
      - "chadburn.job-exec.gdrive-backup.schedule=0 5 * * *"
      - "chadburn.job-exec.gdrive-backup.command=python /app/gdrive_backup.py"

  immich-import:
    build:
      context: .
      dockerfile: immich-import/Dockerfile
    image: immich-import:latest
    container_name: immich-import
    restart: "no"
    environment:
      - IMMICH_SERVER=${IMMICH_SERVER}
      - IMMICH_API_KEY_FILE=/run/secrets/immich_api_key
      - IMPORT_DIR=/data/import
      - METADATA_DIR=/data/metadata
      - EXTRACT_DIR=/data/extracted
      - DELETE_AFTER_IMPORT=true
      - PAUSE_IMMICH_JOBS=true
    volumes:
      - ${GDRIVE_PATH}/Takeout:/data/import/Takeout
      - ${STATE_PATH}/.immich_api_key:/run/secrets/immich_api_key:ro
      - ${IMPORTS_PATH}/metadata:/data/metadata
      - ${IMPORTS_PATH}:/data/extracted
    network_mode: bridge
    labels:
      - "chadburn.enabled=true"
      - "chadburn.job-exec.immich-import.schedule=0 5 * * *"
      - "chadburn.job-exec.immich-import.command=python /app/immich_import.py"

  automated-takeout:
    build:
      context: ./automated-takeout
    image: automated-takeout:latest
    container_name: automated-takeout
    restart: "no"
    environment:
      - BROWSER_PROFILE=/browser-profile
      - HEADLESS=true
      - SERVER_IP=${SERVER_IP:-192.168.1.216}
      - VNC_PORT=6901
      - TAKEOUT_URL=https://takeout.google.com/settings/takeout/custom/photos
      - SLEEP_MULTIPLIER=1
      - GOOGLE_PASSWORD=${GOOGLE_PASSWORD:-}
    volumes:
      - ${STATE_PATH}/chromeuser:/browser-profile
      - ${STATE_PATH}/album_state.yml:/app/album_state.yml
    network_mode: bridge
    labels:
      - "chadburn.enabled=true"
      - "chadburn.job-exec.automated-takeout.schedule=10 1 * * *"
      - "chadburn.job-exec.automated-takeout.command=python /app/automated_takeout.py"

  login-helper:
    build:
      context: ./login-helper
      args:
        BASE_IMAGE_VERSION: ${kasmweb_version}
    image: login-helper:latest
    container_name: login-helper
    restart: "no"
    environment:
      - BROWSER_PROFILE=/home/kasm-user/.config/google-chrome
      - HEADLESS=true
      - SERVER_IP=${SERVER_IP:-192.168.1.216}
      - VNC_PORT=6901
      - VNC_PW=${VNC_PASSWORD:-password}
      - SLEEP_MULTIPLIER=0.5
      - PROTECTED_PAGE_URL=https://takeout.google.com/settings/takeout/custom/photos
      - LOGIN_REDIRECT_URL=accounts.google.com
      - LOGIN_PAGE_LOCATOR=input[type="email"]
    volumes:
      - ${STATE_PATH}/chromeuser:/home/kasm-user/.config/google-chrome
    ports:
      - "6901:6901"
    network_mode: bridge
    shm_size: '2gb'
    depends_on:
      version-watcher:
        condition: service_completed_successfully
    labels:
      - "chadburn.enabled=true"
      - "chadburn.job-exec.login-helper.schedule=5 1 * * *"
      - "chadburn.job-exec.login-helper.command=/app/check_login.sh"

  version-watcher:
    build:
      context: ./version-watcher
    image: version-watcher:latest
    container_name: version-watcher
    restart: "no"
    environment:
      - DOCKER_IMAGE=kasmweb/chrome
      - SERVICE_NAME=login-helper
      - ENV_VAR_NAME=kasmweb_version
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose.yml:/app/project/docker-compose.yml:ro
      - ./.env:/app/project/.env:rw
    working_dir: /app
    network_mode: bridge
    labels:
      - "chadburn.enabled=true"
      - "chadburn.job-exec.version-watcher.schedule=0 1 * * *"
      - "chadburn.job-exec.version-watcher.command=python /app/version_watcher.py"

  metadata-viewer:
    build:
      context: ./metadata-viewer
    image: metadata-viewer:latest
    container_name: metadata-viewer
    restart: unless-stopped
    environment:
      - METADATA_DIR=/data/metadata
    volumes:
      - ${IMPORTS_PATH}/metadata:/data/metadata:ro
    ports:
      - "5050:5000"
    network_mode: bridge
    labels:
      - "net.unraid.docker.webui=http://[IP]:[PORT:5050]"
      - "net.unraid.docker.icon=https://raw.githubusercontent.com/immich-app/immich/main/docs/static/img/favicon.png"
      - "net.unraid.docker.managed=composeman"

  vscode-monitor:
    build:
      context: ./vscode-monitor
      args:
        COPILOT_VERSION: ${COPILOT_VERSION:-latest}
    image: vscode-monitor:latest
    container_name: vscode-monitor
    restart: "no"
    # Run as root for full docker access
    user: "0:0"
    # Enable host PID namespace for nsenter to work (needed for Unraid notify)
    pid: host
    privileged: true
    environment:
      - LOG_DIR=/app/logs
      - GH_TOKEN=${GH_TOKEN:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      # Git user config for commits (uses repo local config if not set)
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-Copilot Agent}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-copilot@users.noreply.github.com}
      - GIT_COMMITTER_NAME=${GIT_COMMITTER_NAME:-Copilot Agent}
      - GIT_COMMITTER_EMAIL=${GIT_COMMITTER_EMAIL:-copilot@users.noreply.github.com}
      # Copilot model - use Claude Opus 4.5 by default
      - COPILOT_MODEL=${COPILOT_MODEL:-claude-sonnet-4.5}
      # Copilot version - if set, upgrade to this version at runtime
      - COPILOT_VERSION=${COPILOT_VERSION:-}
      # Unraid notify script path inside container
      - UNRAID_NOTIFY=/unraid/notify
      # Application name for paths
      - APP_NAME=${APP_NAME:-takeout-script}
      - APP_ROOT=${APP_ROOT:-/mnt/user/appdata}
      # FileBrowser config for analysis file links
      - FILEBROWSER_BASE_URL=${FILEBROWSER_BASE_URL:-}
      - FILEBROWSER_ANALYSIS_PATH=${FILEBROWSER_ANALYSIS_PATH:-}
      # Home Assistant VM healthcheck config
      - HA_VM_NAME=hammassistant
      - HA_URL=http://192.168.1.179:8123
      - HA_TOKEN=${HA_TOKEN:-}
    volumes:
      # Docker socket for container management (restart, logs, build)
      - /var/run/docker.sock:/var/run/docker.sock
      # Libvirt socket for VM management (Home Assistant VM healthcheck)
      - /var/run/libvirt/libvirt-sock:/var/run/libvirt/libvirt-sock:ro
      # Host SSH keys for accessing VMs
      - /root/.ssh:/root/.ssh:ro
      - .:/app:rw
      - ./state:/state:rw
      - ./docker-compose.yml:/app/docker-compose.yml:ro
      - ${APP_ROOT}/onedrive/docker:/app/onedrive:ro
      - ${APP_ROOT}/immich/docker:/app/immich:ro
      - ${APP_ROOT}/jumpflix/docker:/app/jumpflix:ro
      - ${APP_ROOT}/chadburn/docker-compose.yml:/app/chadburn/docker-compose.yml:rw
      - ${APP_ROOT}:${APP_ROOT}:ro
      - ./vscode-monitor/copilot_prompt.md:/app/copilot_prompt.md:ro
      - ./state/.copilot-token:/root/.copilot-token:ro
    working_dir: /app
    network_mode: bridge
    labels:
      - "chadburn.enabled=true"
      - "chadburn.job-exec.vscode-monitor.schedule=0 6 * * *"
      - "chadburn.job-exec.vscode-monitor.command=python3 /app/monitor_takeout.py"